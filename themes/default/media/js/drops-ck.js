/**
 * Drops module
 */(function(e){Drops=e.Drops={};var t=Backbone.Model.extend(),n=Backbone.Collection.extend({model:t,comparator:function(e){return parseInt(e.get("id"))}}),r=Backbone.View.extend({tagName:"article",className:"drop base cf",events:{mouseover:function(){this.$(".drop-body p.remove-small").show()},mouseout:function(){this.$(".drop-body p.remove-small").hide()},"click p.remove-small":"delete"},initialize:function(e){this.template=_.template($("#discussion-template").html())},render:function(e){this.$el.html(this.template(this.model.toJSON()));return this},"delete":function(){(new ConfirmationWindow("Delete this comment?",function(){model=this.model;view=this;model.save({comment_text:"This comment has been removed",deleted:!0},{wait:!0,success:function(){view.render()},error:function(){showConfirmationMessage("Unable to delete comment. Try again later.")}})},this)).show();return!1}}),i=Backbone.Model.extend(),s=Backbone.Collection.extend({model:i}),o=Backbone.Model.extend(),u=Backbone.Collection.extend({model:o}),a=Backbone.Model.extend(),f=Backbone.Collection.extend({model:a}),l=Drops.Drop=Backbone.Model.extend({initialize:function(){if(this.get("droplet_image")!=undefined){this.get("droplet_image").thumbnails!=undefined&&this.get("droplet_image").thumbnails["200"]!=undefined&&this.set("droplet_image_url",this.get("droplet_image").thumbnails[200]);this.has("droplet_image_url")||this.set("droplet_image_url",site_url+"media/thumb/?src="+encodeURIComponent(this.get("droplet_image").url)+"&w=200")}},setBucket:function(e){buckets=this.get("buckets");if(this.isInBucket(e)){buckets=_.filter(buckets,function(t){return t["id"]!=e.get("id")});this.set("buckets",buckets)}else buckets.push({id:e.get("id"),bucket_name:e.get("bucket_name")});this.save({buckets:buckets},{wait:!0})},isInBucket:function(e){return _.any(this.get("buckets"),function(t){return t["id"]==e.get("id")})},score:function(e){var t=e-this.get("user_score");t>1?t=1:t<-1&&(t=-1);this.save({user_score:t,droplet_score:{user_score:t,user_id:window.logged_in_user}})}}),c=Drops.DropsList=Backbone.Collection.extend({model:l,comparator:function(e){return Date.parse(e.get("droplet_date_pub"))},add:function(e,t){var n=this.length==0;Backbone.Collection.prototype.add.call(this,e,t);if(!n){var r=[];dropsList=this;_.each(e,function(e){r.push(dropsList.get(e.id))});this.trigger("drops",r)}}}),h=Backbone.View.extend({showAddToBucketModal:function(){var e=new m({collection:Assets.bucketList,model:this.model});modalShow(e.render().el);return!1},showDropScore:function(e){var t=this.$(e);t.toggleClass("selected");t.hasClass("selected")&&t.siblings("li").removeClass("selected")},likeDrop:function(){this.model.score(1);return!1},dislikeDrop:function(){this.model.score(-1);return!1},updateDropScore:function(){new_score=this.model.get("user_score");old_score=this.model.previous("user_score");new_score==1||new_score==0&&old_score==1?this.showDropScore("ul.score-drop > li.star"):(new_score==-1||new_score==0&&old_score==-1)&&this.showDropScore("ul.score-drop > li.remove")},shareDrop:function(){if(!window.public_registration_enabled)showConfirmationMessage("Drop sharing is not allowed in this deployment");else{shareView=new S({model:this.model,baseURL:this.options.baseURL});modalShow(shareView.render().el)}return!1}}),p=h.extend({tagName:"article",events:{"click a.zoom-trigger":"showDetail","click p.discussion a":"showDetail","click li.bucket a.modal-trigger":"showAddToBucketModal","click ul.score-drop > li.star a":"likeDrop","click ul.score-drop > li.remove a":"dislikeDrop","click li.share > a":"shareDrop"},initialize:function(e){var t=null;if(e.layout=="list"){t=this.make("article",{"class":"drop base cf"});this.template=_.template($("#drop-list-view-template").html())}else if(e.layout=="photos"){t=this.make("article",{"class":"drop col_3 base"});this.template=_.template($("#drop-photos-view-template").html())}else{t=this.make("article",{"class":"drop col_3 base"});this.template=_.template($("#drop-drops-view-template").html())}this.setElement(t);this.model.on("change:user_score",this.updateDropScore,this);this.model.on("change:comment_count",this.render,this)},render:function(e){this.$el.html(this.template(this.model.toJSON()));return this},showDetail:function(){this.options.router.navigate("/drop/"+this.model.get("id")+"/zoom",{trigger:!0});return!1}}),d=Drops.DropDetailView=h.extend({tagName:"div",className:"modal drop drop-full col_9",isFetching:!1,lastId:Math.pow(2,32)-1,isAtLastPage:!1,maxId:0,renderDiscussionCollection:!1,isPollingStarted:!1,isSyncing:!1,events:{"click .add-comment .drop-actions a":"addReply","click li.bucket a.modal-trigger":"showAddToBucketModal","click .settings-toolbar .button-big a":"showFullDrop","click ul.score-drop > li.star a":"likeDrop","click ul.score-drop > li.remove a":"dislikeDrop","click li.share > a":"shareDrop","click #discussions_next_page":"loadComments","click #new_comments_alert a":"showNewComments","click a.button-prev":"showPrevDrop","click a.button-next":"showNextDrop"},initialize:function(e){this.template=_.template($("#drop-detail-template").html());if(this.model.has("discussion_collection")){this.discussions=this.model.get("discussion_collection");this.renderDiscussionCollection=!0}else{this.discussions=new n;this.discussions.url=e.baseURL+"/reply/"+this.model.get("id");this.model.set("discussion_collection",this.discussions);this.loadComments()}this.discussions.on("add",this.addDiscussion,this);this.model.on("change:user_score",this.updateDropScore,this);this.newComments=new n;this.newComments.url=e.baseURL+"/reply/"+this.model.get("id");this.newComments.on("add",this.alertNewComments,this);this.newComments.on("reset",this.resetNewCommentsAlert,this)},render:function(e){this.$el.html(this.template(this.model.toJSON()));this.renderDiscussionCollection&&this.discussions.each(this.addDiscussion,this);return this},addDiscussion:function(e){if(parseInt(e.get("id"))<this.lastId||!this.lastId)this.lastId=parseInt(e.get("id"));parseInt(e.get("id"))>this.maxId&&(this.maxId=parseInt(e.get("id")));this.discussions.length>=20&&this.$("section.drop-discussion p.button-white").parent().show();var t=new r({model:e});e.view=t;var n=this.discussions.indexOf(e);n>0?this.discussions.at(n-1).view.$el.before(t.render().el):this.$("section.drop-discussion p.button-white").parent().before(t.render().el)},addReply:function(e){var t=this.$(".add-comment textarea");if(!$(t).val().length)return!1;var n=this.$(".add-comment .drop-actions p").clone(),r=window.loading_message.clone();this.$(".add-comment .drop-actions p").replaceWith(r);var i=this.model;this.discussions.create({comment_text:$(t).val()},{wait:!0,complete:function(){r.replaceWith(n)},success:function(e,n){t.val("");i.set("comment_count",parseInt(i.get("comment_count"))+1)},error:function(e,t){showConfirmationMessage("Unable to add comment. Try again later.")}});return!1},doPollComments:function(){this.isPollingStarted=!0;view=this;var e=setTimeout(function(){view.isSyncing?view.doPollComments():view.newComments.fetch({data:{since_id:view.maxId},add:!0,complete:function(){view.$el.is(":visible")&&view.doPollComments()}})},6e4+Math.floor(Math.random()*6e4+1))},alertNewComments:function(e){parseInt(e.get("id"))>this.maxId&&(this.maxId=parseInt(e.get("id")));var t=this.newComments.length+" new comment"+(this.newComments.length>1?"s":"");this.$("#new_comments_alert span.message").html(t);this.$("#new_comments_alert").show()},resetNewCommentsAlert:function(){this.$("#new_comments_alert").fadeOut("slow",function(){$(this).find("span.message").html("")})},showNewComments:function(){if(this.isSyncing)return;this.isSyncing=!0;this.discussions.add(this.newComments.models);this.newComments.reset();this.isSyncing=!1;return!1},loadComments:function(){if(this.isFetching||this.isAtLastPage)return!1;this.isFetching=!0;view=this;this.discussions.fetch({data:{last_id:view.lastId},add:!0,complete:function(e,t){setTimeout(function(){view.isFetching=!1},700);view.isPollingStarted||view.doPollComments()},error:function(e,t){if(t.status==404){view.isAtLastPage=!0;var n=view.$("#no_comments_alert");view.discussions.length&&view.$("section.drop-discussion p.button-white").parent().replaceWith(n.show())}}});return!1},showFullDrop:function(){this.options.router.navigate("/drop/"+this.model.get("id"),{trigger:!0});return!1},showPrevDrop:function(){this.model.prev&&this.options.router.navigate("/drop/"+this.model.prev.get("id")+"/zoom",{trigger:!0});return!1},showNextDrop:function(){this.model.next&&this.options.router.navigate("/drop/"+this.model.next.get("id")+"/zoom",{trigger:!0});return!1}}),v=Drops.BucketView=Backbone.View.extend({tagName:"label",events:{"click input":"toggleBucket"},initialize:function(){this.template=_.template($("#bucket-template").html())},render:function(){var e=this.model,t=this.options.drop.get("buckets"),n=typeof _.find(t,function(t){return t["id"]==e.get("id")})!="undefined";e.set("containsDrop",n);this.$el.html(this.template(e.toJSON()));return this},setSelected:function(){this.$el.addClass("selected");this.$("input[type=checkbox]").prop("checked",!0)},toggleBucket:function(){this.options.drop.setBucket(this.model);this.$("input[type=checkbox]").is(":checked")?this.$el.addClass("selected"):this.$el.removeClass("selected")}}),m=Drops.AddToBucketView=Assets.BaseModalAssetListView.extend({tagName:"article",className:"modal",listSelector:".select-list",listItemSelector:".select-list label",initialize:function(e){this.template=_.template($("#add-to-bucket-template").html());this.$el.html(this.template(this.model.toJSON()));Assets.BaseAssetListView.prototype.initialize.call(this,e)},getView:function(e){return new v({model:e,drop:this.model})},renderAsset:function(e){return e.get("is_owner")},onSaveNewBucket:function(e){this.model.isInBucket(e)||this.model.setBucket(e)}}),g=Drops.DropsView=Backbone.View.extend({noContentElHidden:!1,events:{"click article.alert-message a":"showNewDrops"},initialize:function(e){this.template=_.template($("#drop-listing-template").html());e.layout=="list"?this.setElement(this.make("article",{"class":"river list"})):this.setElement(this.make("article",{"class":"river drops cf",style:"position: relative;"}));e.dropsList.on("reset",this.initDrops,this);e.dropsList.on("destroy",this.checkEmpty,this);e.layout=="list"?e.dropsList.on("add",this.addDrop,this):e.dropsList.on("drops",this.addDrops,this);e.newDropsList.on("add",this.alertNewDrops,this);e.newDropsList.on("reset",this.resetNewDropsAlert,this)},render:function(){this.$el.html(this.template());this.alertNewDrops();return this},addDrops:function(e){var t=this,n=[],r=this.options.maxId;_.each(e,function(e){r=Math.max(r,e.get("sort_id"));n.push((new p({model:e,layout:this.options.layout,baseURL:t.options.baseURL,router:t.options.router})).render().el)},this);var i=$(n).css({opacity:0}),s=this.$("#drops-view");r>this.options.maxId?s.prepend(i):s.append(i);i.imagesLoaded(function(){i.animate({opacity:1});r>t.options.maxId?s.masonry("reload"):s.masonry("appended",$(n),!0)})},addDrop:function(e){var t=new p({model:e,layout:this.options.layout,baseURL:this.options.baseURL,router:this.options.router});e.view=t;var n=this.options.dropsList.indexOf(e),r=this.options.dropsList.length-1;if(r>0){e.prev=n>0?this.options.dropsList.at(n-1):this.options.dropsList.at(r);e.next=n==r?this.options.dropsList.at(0):this.options.dropsList.at(n+1);e.prev.next=e;e.next.prev=e}else{e.prev=null;e.next=null}if(this.options.layout=="list"){var i=this.options.dropsList.indexOf(e);i>0?this.options.dropsList.at(i-1).view.$el.before(t.render().el):this.$("#drops-view").append(t.render().el)}else{t.render().$el.css({opacity:0});this.$("#drops-view").prepend(t.el)}this.noContentElHidden||this.hideNoContentEl()},initDrops:function(){this.$("article.drop").remove();var e=!1;if(this.$("#drops-view").hasClass("masonry")){this.$("#drops-view").masonry("destroy");e=!0}if(!this.checkEmpty()){this.hideNoContentEl();this.options.dropsList.each(this.addDrop,this)}e&&this.masonry()},masonry:function(){var e=this.$("#drops-view"),t=this;e.imagesLoaded(function(){t.$("article.drop").animate({opacity:1});if(t.options.layout=="drops"||t.options.layout=="photos")window.innerWidth>=615&&window.innerWidth<=960?e.masonry({itemSelector:"article.drop",isAnimated:!Modernizr.csstransitions,columnWidth:function(e){return e/3}}):window.innerWidth>=960&&e.masonry({itemSelector:"article.drop",isAnimated:!Modernizr.csstransitions,columnWidth:function(e){return e/4}})})},hideNoContentEl:function(){this.$(".no-content").hide();this.noContentElHidden=!0},checkEmpty:function(){if(!this.options.dropsList.length){var e=this.$(".no-content");this.$el.remove();$("#content").removeClass("river").addClass("cf").append(e);e.show();this.noContentElHidden=!1;return!0}return!1},alertNewDrops:function(){var e=this.options.newDropsList.size();if(e>0){var t='<p style="text-align:center"><a href="#">'+e+" new drop"+(e==1?"":"s")+". "+"Click here to refresh the view</a></p>";if(this.$("article.alert-message").length==0){var n='<div class="center cf"><article class="container base alert-message">'+t+"</article>"+"</div>";this.$el.prepend(n).fadeIn(350)}else this.$("article.alert-message").html(t)}},showNewDrops:function(){this.options.dropsList.add(this.options.newDropsList.models);this.options.newDropsList.reset()},resetNewDropsAlert:function(){this.$("article.alert-message").fadeOut("slow").remove()}}),y=Backbone.View.extend({tagName:"li",events:{"click span.remove-small":"removeMeta"},initialize:function(){this.template=_.template($("#edit-metadata-listitem").html())},render:function(){var e="";metadata=this.model;if(metadata instanceof i)e=metadata.get("tag");else if(metadata instanceof o){var t=metadata.get("url");t=t.length>30?t.substr(0,30)+"...":t;e=t}else metadata instanceof a&&(e=metadata.get("place_name"));this.$el.html(this.template({label:e}));return this},setSelected:function(){this.$el.addClass("selected")},removeMeta:function(){this.model.destroy();this.$el.fadeOut("slow")}}),b=Backbone.View.extend({tagName:"article",className:"modal",events:{"click .create-new a":"saveNewMetadata",submit:"saveNewMetadata"},initialize:function(){this.template=_.template($("#add-metadata-template").html());this.collection.on("add",this.addMetadata,this)},addMetadata:function(e){var t=new y({model:e});this.$(".link-list ul").append(t.render().el);e.view=t;return!1},render:function(){var e=this.model.toJSON();this.collection instanceof s?e.label="tag":this.collection instanceof u?e.label="link":this.collection instanceof f&&(e.label="location");this.$el.html(this.template(e));this.collection.each(this.addMetadata,this);return this},isPageFetching:!1,saveNewMetadata:function(){var e=$.trim(this.$(".create-new input[name=new_metadata]").val());if(!e.length||this.isPageFetching)return!1;var t=this.collection.find(function(t){if(t instanceof i)return t.get("tag_canonical")==e.toLowerCase();if(t instanceof o)return t.get("url")==e;if(t instanceof a)return t.get("place_name_canonical")==e.toLowerCase()});if(t){var n=t.view.$el.offset().top-this.$(".link-list").offset().top;(n<0||n>this.$(".link-list").height())&&this.$(".link-list").animate({scrollTop:this.$(".link-list").scrollTop()+n},600);t.view.setSelected();this.$(".create-new input[name=new_metadata]").val("");this.isPageFetching=!1;return!1}var r=window.loading_message.clone(),l=this.$(".create-new .field").clone();this.$(".create-new .field").replaceWith(r);this.collection instanceof s?t=new i({tag:e}):this.collection instanceof u?t=new o({url:e}):this.collection instanceof f&&(t=new a({place_name:e}));var c=this;this.collection.create(t,{wait:!0,complete:function(){c.isPageFetching=!1;r.replaceWith(l)},error:function(e,t){var n="";if(t.status==400){errors=JSON.parse(t.responseText).errors;_.each(errors,function(e){n+="<li>"+e+"</li>"})}else n="Oops something went wrong. Try again later.";flashMessage(c.$(".system_error"),n)},success:function(){c.$(".link-list").animate({scrollTop:c.$(".link-list").scrollTop()+(c.$(".link-list li").last().offset().top-c.$(".link-list").offset().top)},600);t.view.setSelected();c.$(".create-new input[name=new_metadata]").val("")}});return!1}}),w=Backbone.View.extend({tagName:"section",className:"meta-data",events:{"mouseover h3":function(){this.$("h3 .button-blue").show()},"mouseout h3":function(){this.$("h3 .button-blue").hide()},"click h3 a":"showEditMetadata"},initialize:function(){this.template=_.template($("#metadata-template").html());this.collection.on("add",this.addMetadata,this)},render:function(){this.$el.html(this.template());this.collection instanceof s?this.$("h3 .icon").after("Tags"):this.collection instanceof u?this.$("h3 .icon").after("Links"):this.collection instanceof f&&this.$("h3 .icon").after("Places");this.collection.each(this.addMetadata,this);return this},addMetadata:function(e){var t="<li>";if(e instanceof i)t+='<a href="#">'+e.get("tag")+"</a>";else if(e instanceof o){var n=e.get("url");n=n.length>20?n.substr(0,20)+"...":n;t+='<a href="'+e.get("url")+'" target="_blank" title="'+e.get("url")+'">'+n+"</a>"}else e instanceof a&&(t+='<a href="#">'+e.get("place_name")+"</a>");t+="</li>";var r=$(t);this.$(".meta-data-content .meta-list").append(r);e.on("destroy",function(){r.fadeOut("slow")})},showEditMetadata:function(){var e=new b({model:this.model,collection:this.collection});modalShow(e.render().el);return!1}}),E=Drops.DropFullView=Backbone.View.extend({tagName:"article",className:"drop drop-full cf",initialize:function(e){this.template=_.template($("#drop-full-view-template").html())},render:function(){this.$el.html(this.template());var e=new d({model:this.model,baseURL:this.options.baseURL,router:this.options.router});this.$("article .center .col_3").before(e.render().el);var t=new f;t.url=this.options.baseURL+"/places/"+this.model.get("id");t.reset(this.model.get("places"));this.addMetadataBlock(t);var n=new u;n.url=this.options.baseURL+"/links/"+this.model.get("id");n.reset(this.model.get("links"));this.addMetadataBlock(n);var r=new s;r.url=this.options.baseURL+"/tags/"+this.model.get("id");r.reset(this.model.get("tags"));this.addMetadataBlock(r);window.fullView=this;return this},addMetadataBlock:function(e){var t=new w({collection:e,model:this.model});this.$("article .center .col_3").append(t.render().el)}}),S=Backbone.View.extend({tagName:"article",className:"modal",events:{"click li.email > a":"showEmailDialog"},initialize:function(e){this.template=_.template($("#share-drop-template").html())},showEmailDialog:function(){var e=new x({model:this.model,baseURL:this.options.baseURL});modalShow(e.render().el);return!1},render:function(){var e=this.model.toJSON();e.drop_url=site_url.substring(0,site_url.length-1)+this.options.baseURL+"/drop/"+e.id;this.$el.html(this.template(e));return this}}),x=Backbone.View.extend({tagName:"article",className:"modal",events:{"click #send_sharing_email > a":"sendEmail"},initialize:function(e){this.template=_.template($("#email-dialog-template").html())},sendEmail:function(){var e={};$(":input",this.$("form")).each(function(t){e[$(this).attr("name")]=$(this).val()});var t=this;$.ajax({url:this.options.baseURL+"/share",type:"POST",data:e,success:function(e){t.$("#success").show();setTimeout(function(){t.$("h2.close a").trigger("click")},1500)},error:function(){t.$("#error").show()},dataType:"json"});return!1},render:function(){var e=this.model.toJSON();e.drop_url=site_url.substring(0,site_url.length-1)+this.options.baseURL+"/drop/"+e.id;this.$el.html(this.template(e));return this}})})(this);